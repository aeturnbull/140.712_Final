---
title: "20181204_140712_Final"
author: "Alison E. Turnbull"
date: "December 4, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("tidyverse")
```

### Motivation and Overview: Provide an overview of the project goals and the motivation for it. Consider that this will be read by people who did not see your project proposal.

### Related Work: Anything that inspired you, such as a paper, a web site, or something we discussed in class.

### Initial Questions: What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

##### The two main questions I want to answer are: 

1. Are there patterns in the way physicians in this study conversed with family members during the simulated family meetings? 
        a. Are there textual features within the simulation transcripts that cluster together? 
            + If so, how can the clusters be described?
        b. Are there physician characteristics that are correlated with the 3 clusters?
        c. Do the clusters correlate with how the actors or physician colleagues rated the doctors?

2. Which textual features best predict whether the physician colleagues think prognosis for survival was disclosed? 
        a. Are there correlations between either MD characteristics and predicted probability of prognosis disclosure?


### Data: What is the data source? Document the data import, wrangling, etc.

##### These data were collected as part of an IRB-approved randomized train of an intervention designed 



##### Because there are potential identifiers in the data, I am going to create a de-identified version for this analysis.  This next chunk cannot be evaluated, but it will show you where the data frame containing data on physician characteristics came from and how it was wrangled.  I will then remove these data frames, leaving behind only the di-identified version for the rest of this analysis. 
```{r, warning=FALSE, message=FALSE, eval=FALSE}
## Loading in the study data which is contained in multiple dataframes connected by a shared unique identifier variable called "uid"
    load("X:/Moore Early Career Investigator Award/Aim 3/Study Data/Data shared with Di Chen/[20180312] dataset v5/20180313_SCIP data & codebook.RData")

## Loading data on location of home hospital and merging that information into the dataframe containing physician characteristics
    location<-read_csv("20180704_Participant hospital locations.csv")
    md<-merge(md, location, by="uid")

## Extracting variables relevant to this analysis    
 ## The md dataframe contains physician characteristics
    md<-md %>%
        select(uid, age, gender, race, tx, religion_importance, icu_weeks, icu_type, train_med, train_sx, train_em, train_anes, hosp_ac_st_univ, baltimore, state)
    
 ## The pre_dta dataframe contains data the doctors self-reported before the simulation
    pre_dta<-pre_dta %>%
        select(uid, prognosis_survive, prognosis_mc, consult_palliative)
    
 #The post_dta dataframe contains data the doctors self-reported after the simulation       
    post_dta<-post_dta %>%
        select(uid, disagreement_perceived, tracheotomy, withdraw_life_support)
    
 #The post_sp dataframe contains actor assessments of the simulation reported immediately afterward
    post_sp<-post_sp %>%
        select(uid, effort_to_help, effort_to_listen, effort_to_include, disagreement, sp)
    
 #The outcome dataframe contains assessments of the simulations provided by blinded colleague reviewers reading transcriptions
    outcome<-outcome %>%
        filter(assesser=="final") %>%
        select(uid, comfort, comfort_understandable, withdraw, death, death_word, prognosis, assesser)
    
## Merging all these data sources together     
    dta<-Reduce(function(x, y) merge(x, y, by="uid"), list(md, pre_dta, post_dta, post_sp, outcome))
    
 ## Removing redundant dataframes and those with potentially identifying information
    rm(key, location, md, outcome, post_dta, post_sp, pre_dta)
     
    write_csv(dta, "140.712_Final_dta.csv") 
```

##### Reading in sharable csv files  
```{r, warning=FALSE, message=FALSE}
    dta<-read_csv("140.712_Final_dta.csv")
    sum_measures<-read_csv("summary_measures.csv")
        ## Renaming the unique identifier in this dataframe for merging purposes:
        sum_measures<-rename(sum_measures, uid=study_id)
    
    ## Here's data on how long each simulation went on.
    duration<-read_csv("20180810_Simulation_duration.csv")
    sum_measures<-merge(sum_measures, duration, by="uid")
```

##### Cleaning the summary measures and creating new variables
```{r}
    dta<-dta %>% arrange(uid)
    sum_measures<-sum_measures %>% arrange(uid)

sum_measures<-sum_measures %>%
    mutate(mins=signif(as.numeric(duration/60)), 3) %>%          ## Total duration of the simulation in minutes
    mutate(wrd_total=wrd_cnt_phys+wrd_cnt_prox) %>%              ## Total number of words spoken during simulation
    
    mutate(totalwrd_per_min=wrd_total/mins) %>%                  ## Total words per minute within simulation
    mutate(physwrd_per_min=wrd_cnt_phys/mins) %>%                ## Physician words per minute
    mutate(proxwrd_per_min=wrd_cnt_prox/mins) %>%                ## Proxy words per minute
    mutate(wrdratio_physprox=wrd_cnt_phys/wrd_cnt_prox) %>%      ## Ratio of physician:proxy words
    
    mutate(uttratio_physprox=uttr_cnt_phys/uttr_cnt_prox) %>%    ## Ratio of physician:proxy utterances
    
    mutate(i_my_cnt=pron_i_cnt+pron_my_cnt) %>%                  ## Count of the number of the pronouns "I" and "my"
    mutate(you_your_cnt=pron_you_cnt+pron_your_cnt) %>%          ## Count of the number of the pronouns "you" and "your"
    mutate(she_hers=pron_she_cnt+pron_her_cnt+pron_hers_cnt) %>% ## Count of the number of the pronouns "she" and "her" and "hers"
    mutate(he_his=pron_he_cnt+pron_his_cnt) %>%                  ## Count of the number of the pronouns "he" and "his"
    mutate(i_my_prop=signif(i_my_cnt/wrd_total, 3)) %>%          ## Proportion of all words that are "I" or "my"
    mutate(you_your_prop=signif(you_your_cnt/wrd_total, 3)) %>%  ## Proportion of all words that are "you" or "yours"
    mutate(she_her_prop=signif(she_hers/wrd_total, 3)) %>%       ## Proportion of all words that are "her" or "hers"
    mutate(he_his_prop=signif(he_his/wrd_total, 3))  %>%         ## Proportion of all words that are "he" or "his"
    
    mutate(phys_verb_prop=signif(phys_verb_cnt/wrd_cnt_phys, 3)) %>%     ## Proportion of physician words that are verbs
    mutate(phys_noun_prop=signif(phys_noun_cnt/wrd_cnt_phys, 3)) %>%     ## Proportion of physician words that are nouns
    mutate(phys_adj_prop=signif(phys_adjective_cnt/wrd_cnt_phys, 3)) %>% ## Proportion of physician words that are adjectives
    mutate(phys_adv_prop=signif(phys_adverb_cnt/wrd_cnt_phys, 3))%>%     ## Proportion of physician words that are adverbs
    
    mutate(voa_prop=signif(voa_cnt/wrd_total, 3)) %>%                    ## Proportion of words in the VOA lexicon
    mutate(nlm_prop=signif(nlm_minus_voa_cnt/wrd_total, 3)) %>%          ## Proportion of words in the nlm but not not VOA lexicon
    mutate(death_word=dta$death_word)                                    ## Also, there's a variable currently in the "dta" dataframe which indicates whether the physician used the words "death", "die", or "dying."
    
    
    ## Keeping the scaled, cleaned features
    sum_measures<-sum_measures %>%
        select(uid, wrd_total, wrd_cnt_phys, wrd_cnt_prox, wrdratio_physprox, mins, totalwrd_per_min, 
              physwrd_per_min, proxwrd_per_min, uttratio_physprox, mean_wrds_uttr_phys, median_wrds_uttr_phys, 
              mean_wrds_uttr_prox, median_wrds_uttr_prox,
              voa_prop, nlm_prop, fk_score, gf_score, pattern_sent,
              wwbp_to_past, wwbp_to_present, wwbp_to_future,
              i_my_prop, you_your_prop, she_her_prop, he_his_prop, 
              phys_verb_prop, phys_noun_prop, phys_adj_prop, phys_adv_prop, death_word)
```


*Exploratory Data Analysis: What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions? You should use this section to motivate the statistical analyses that you decided to use in the next section.


##### First exploring the physician characteristics
```{r}
dta_long_con<-dta %>%
    select(uid, age, icu_weeks, disagreement, disagreement_perceived, effort_to_help, effort_to_listen, effort_to_include) %>%
    gather(key=feature, value = value, -uid) 

dta_long_con %>%
    ggplot(aes(value)) +
    geom_density(alpha=0.5)+
    facet_wrap( ~feature, scales='free', ncol=3) +
    labs(x = NULL, y = NULL) +
    theme_bw()

dta_long_cat<-dta %>%
    select(-c(age, icu_weeks, disagreement, disagreement_perceived, effort_to_help, effort_to_listen, effort_to_include)) %>%
    gather(key=feature, value = value, -uid) 

dta_long_cat %>%
    ggplot(aes(value)) +
    geom_bar() +
    facet_wrap( ~feature, scales='free', ncol=5) +
    labs(x = NULL, y = NULL) +
    theme_bw()
```

```{r, warning=FALSE, message=FALSE}
library("GGally")
## Relationships between MD characteristics their case management, and their colleagues' assessment of whether prognosis for survival was disclosed
dta %>%
    mutate(religion=ifelse(religion_importance=="Extremely" | religion_importance=="Very" | religion_importance=="Moderately", 1, 0)) %>%
    mutate(religion=factor(religion)) %>%
    select(age, icu_weeks, baltimore, gender, religion, prognosis_survive, death) %>%
    ggpairs()
```    


```{r, warning=FALSE, message=FALSE}
## Relationships between how actors perceived the physicians and whether the physicians reported conflict during the simulation, colored by disclosure    
dta %>%
    select(disagreement, effort_to_help, effort_to_listen, effort_to_include, disagreement_perceived, death) %>%
    ggpairs(aes(color=factor(death)))
```

```{r, warning=FALSE, message=FALSE}
## Relationships between how actors perceived the physicians and whether the physicians reported conflict during the simulation, colored by actor    
dta %>%
    select(disagreement, effort_to_help, effort_to_listen, effort_to_include, disagreement_perceived, sp) %>%
    ggpairs(aes(color=factor(sp)))
```


```{r, warning=FALSE, message=FALSE}
## Now exploring the transcript characteristics
transcripts_long<-sum_measures %>%
    gather(key=feature, value = value, -uid) 

transcripts_long %>%
    ggplot(aes(value)) +
        geom_density()+
        facet_wrap( ~feature, scales='free', ncol=6) +
        labs(x = NULL, y = NULL) +
        theme_bw()
```

```{r, warning=FALSE, message=FALSE}
## Transcript features by whether colleagues thought death was disclosed
sum_measures %>%
    arrange(uid) %>%
    mutate(disclose = dta$death) %>%
    select(wrd_total, wrd_cnt_phys, wrd_cnt_prox, wrdratio_physprox, disclose) %>%
    ggpairs(aes(color=factor(disclose), alpha=0.5))
```

```{r, warning=FALSE, message=FALSE}
sum_measures %>%
    arrange(uid) %>%
    mutate(disclose = dta$death) %>%
    select(mins, totalwrd_per_min, physwrd_per_min, proxwrd_per_min, disclose) %>%
    ggpairs(aes(color=factor(disclose), alpha=0.5))
```
##### Wow.  So, meetings were a little longer, and there are definitely fewer words per minute spoken when prognosis was disclosed. 

```{r, warning=FALSE, message=FALSE}
sum_measures %>%
    arrange(uid) %>%
    mutate(disclose = dta$death) %>%
    select(uttratio_physprox, mean_wrds_uttr_phys, median_wrds_uttr_phys, mean_wrds_uttr_prox, median_wrds_uttr_prox, disclose) %>%
    ggpairs(aes(color=factor(disclose), alpha=0.5))
```
##### Huh, looks like physicians always speak in paragraphs of about the same length, but proxies spoke a little longer if prognosis was disclosed. 
##### There are some physician:proxy utterance ratio outliers that are interesting too. 

```{r, warning=FALSE, message=FALSE}
sum_measures %>%
    arrange(uid) %>%
    mutate(disclose = dta$death) %>%
    select(voa_prop, nlm_prop, fk_score, gf_score, disclose) %>%
    ggpairs(aes(color=factor(disclose), alpha=0.5))
```
##### What's interseting is how little variability there is here.  Disclosure does NOT appear to be correlated with how simple or complex physician language is. 

```{r, warning=FALSE, message=FALSE}
sum_measures %>%
    arrange(uid) %>%
    mutate(disclose = dta$death) %>%
    select(pattern_sent, wwbp_to_past, wwbp_to_present, wwbp_to_future, disclose) %>%
    ggpairs(aes(color=factor(disclose), alpha=0.5))
```
##### Really nothing of obvious interest here. 

```{r, warning=FALSE, message=FALSE}
sum_measures %>%
    arrange(uid) %>%
    mutate(disclose = dta$death) %>%
    select(i_my_prop, you_your_prop, she_her_prop, he_his_prop, disclose) %>%
    ggpairs(aes(color=factor(disclose), alpha=0.5))
```
### Huh.  There's an interesting shift toward the words "i" and "my" when prognosis is disclosed. 

```{r, warning=FALSE, message=FALSE}
sum_measures %>%
    arrange(uid) %>%
    mutate(disclose = dta$death) %>%
    select(phys_verb_prop, phys_noun_prop, phys_adj_prop, phys_adv_prop, death_word, disclose) %>%
    ggpairs(aes(color=factor(disclose), alpha=0.5))
```
##### I'm not seeing anything very interesting here.  


*Data Analysis: What statistical or computational method did you apply and why? What others did you consider?

1. Are there patterns in the way physicians in this study conversed with family members during the simulated family meetings? 
        a. Are there textual features within the simulation transcripts that cluster together? 
            + If so, how can the clusters be described?
            + Are there strong correlations between cluster and physician characteristics?
            + Do the clusters correlate with how the actors or physician colleagues rated the doctors?

```{r, warning=FALSE, message=FALSE}
library("rafalib")

## Step 1: computing the distance between each transcript using two different distances
    matrix_measures<-sum_measures %>%
        select(-c(uid))

    matrix_measures[which(is.na(matrix_measures$death_word)), "death_word"]    <-"No"
    sum_measures$death_word<-factor(sum_measures$death_word)
    
    ## Distance matrices using two measures
    d_euclid = dist(matrix_measures, method="euclidean")
    d_manhat = dist(matrix_measures, method="manhattan")
    
    ## Hierarchical clustering
    hc_euclid<-hclust(d_euclid)
    hc_manhat<-hclust(d_manhat)
    
    ## Add labels
    hc_euclid$labels<-dta$uid
    hc_manhat$labels<-dta$uid
    
    ## First lets see how the trial arms disperse across the clusters
    myplclust(hc_euclid, lab.col = as.numeric(as.factor(dta$tx)), cex=0.5)  
    myplclust(hc_manhat, lab.col = as.numeric(as.factor(dta$tx)), cex=0.5)  
```

Nope, nothing related to trial arm but 3 clear clusters with a serious outlier.

```{r, warning=FALSE, message=FALSE}    
    ## And now looking at whether there's a pattern by whether colleagues thought prognosis was disclosed
    myplclust(hc_euclid, lab.col = as.numeric(as.factor(dta$death)), cex=0.5)  
    myplclust(hc_manhat, lab.col = as.numeric(as.factor(dta$death)), cex=0.5) 
```
Huh, so, the cluster on the far right seems to be almost entirely red - interesting.
I guess the good news is that euclidian vs manhattan distance doesn't seem to matter. 
There looks like there are 3 pretty clear clusters and #72 is a real outlier.

```{r, warning=FALSE, message=FALSE}
    ## Creating the clusters by cutting the tree
    eu_clusters<-cutree(hc_euclid, h=4000)

    ## Attaching these cluster designations to the dataframe of transcript characteristics
    sum_measures$cluster<-eu_clusters
    sum_measures[which(sum_measures$uid==72), "cluster"]<-2  #I'm moving this outlier into cluster 2 so we only have 3 groups.
```

#####Returning to my first question: 
1. Are there patterns in the way physicians in this study conversed with family members during the simulated family meetings? 
        a. Are there textual features within the simulation transcripts that cluster together? 
            + If so, how can the clusters be described?
```{r}
    library("tableone")
    CreateTableOne(strata="cluster", data=sum_measures)
```

Cool!  Cluster 2 is really interesting - these 14 simulations were almost twice as long, had nearly twice as many words, and more physician words per minute but no more proxy words per minute.  There were also more words per physician utterance, and they were about twice as likely to say the one of the big D words (death, die, or dying).  Differentiating between clusters 1 and 3 is a little harder, but cluster 3 were VERY short meetings in general.  I wonder if they cluster 3 is the physicians who essentially just went in the room and gave a quick update.  

##### Moving on to question 1b. Are there physician characteristics that are correlated with the 3 clusters?

```{r, warning=FALSE, message=FALSE}
## Attaching these cluster designations to the dataframe of physician characteristics
    dta$cluster<-eu_clusters
    dta[which(sum_measures$uid==72), "cluster"]<-2  #I'm moving this outlier into cluster 2 so we only have 3 groups.
    
    MDTable<-dta %>%
        mutate(Race = fct_collapse(race, 
                                   white = "White", 
                                   asian = "Asian", 
                                   other = c("Black or African American", "More than one race", "Prefer not to answer"))) %>%
        mutate(Religion_importance = fct_collapse(religion_importance, 
                                   high = c("Extremely", "Very"), 
                                   moderate = "Moderately", 
                                   low = c("Slightly", "Not at all"), 
                                   Missing = "Prefer not to answer")) %>%
        select(cluster, age, gender, Race, Religion_importance, icu_weeks, icu_type, train_med, train_sx, train_em, train_anes, hosp_ac_st_univ, 
               baltimore, prognosis_survive, prognosis_mc, consult_palliative, disagreement_perceived, tracheotomy, withdraw_life_support)
        
        CreateTableOne(strata = "cluster", data=MDTable)
```

What's most striking here is how few physician characteristics differ by cluster.  So, group 2 is very secular, and they don't perceive any conflict in the room.  Group 3 stands out for having a higher percentage of non-white and non-asian physicians, but otherwise they're very hard to tell from group 1. 

##### Lastly question 1c: Do the clusters correlate with how the actors or physician colleagues rated the doctors?

```{r, warning=FALSE, message=FALSE}
    SPTable<-dta %>%
        mutate(Race = fct_collapse(race, 
                                   white = "White", 
                                   asian = "Asian", 
                                   other = c("Black or African American", "More than one race", "Prefer not to answer"))) %>%
        mutate(Religion_importance = fct_collapse(religion_importance, 
                                   high = c("Extremely", "Very"), 
                                   moderate = "Moderately", 
                                   low = c("Slightly", "Not at all"), 
                                   Missing = "Prefer not to answer")) %>%
        select(cluster, sp, comfort, disagreement, effort_to_help, effort_to_listen, effort_to_include, death)
        
        CreateTableOne(strata = "cluster", data=SPTable)
```
Fascinating.  So, standardized patient "H" is over-represented in cluster 3, and "K" is disproportionately in cluster 2.  
Cluster 2 was way more likely to offer the option of care focused on comfort, and nearly everyone disclosed death.      

##### Moving on to my second question: 
2. Which textual features best predict whether the physician colleagues thought prognosis for survival was disclosed? 
        2b. Are there correlations between either MD characteristics and predicted probability of prognosis disclosure?
        
Looking at measures of variable importance for bagged trees. 
```{r, warning=FALSE, message=FALSE}
library("rpart")
library("caret")
        control <- trainControl(method="repeatedcv", number=5, repeats=3)  ## 5 folds in cross validation, repeated 3 times
        seed <- 12072018
        metric <- "Accuracy"
    
        ## Adding the outcome variable to this dataframe
        sum_measures<-sum_measures %>%
                        arrange(uid) %>%
                        mutate(disclose = as.factor(dta$death))
        
        sum_measures[which(is.na(sum_measures$death_word)), "death_word"]    <-"No"
        
        ## Creating a collection of bagged trees to classify transcripts by whether the colleagus thought prognosis was disclosed. 
        fit_bagging<- train(disclose ~., data=select(sum_measures, -uid, -cluster, -wrd_cnt_phys, -wrd_cnt_prox), 
                            method="treebag", metric=metric, trControl=control)
        
        bagImp<-varImp(fit_bagging, scale = FALSE)
        bagImp_scaled<-varImp(fit_bagging, scale = TRUE)
        plot(bagImp_scaled, top = 10)
```
The predictive nature of the words "I" and "my" are fascinating to me.  I can definitely come up with some hypotheses about what role those pronouns are playing. Lets see how well these results hold up with different classification techniques. 


Looking at measures of variable importance for boosted trees.
```{r, warning=FALSE, message=FALSE}
library("gbm")    
fit_boost<- train(disclose ~., data=select(sum_measures, -uid, -cluster, -wrd_cnt_phys, -wrd_cnt_prox), 
                            method="gbm", metric=metric, trControl=control, verbose=FALSE)
        
        boostImp<-varImp(fit_boost, scale = FALSE)
        boostImp_scaled<-varImp(fit_boost, scale = TRUE)
        plot(boostImp_scaled, top = 10)
```
The top 2 remain strong with numbers 3 - 7 moving around a bit but the line-up remains similar. 

Looking at mean minimal depth within a random forest.
```{r, warning=FALSE, message=FALSE}
    fit_rf<- train(disclose ~., data=select(sum_measures, -uid, -cluster, -wrd_cnt_phys, -wrd_cnt_prox), 
                            method="rf", metric=metric, trControl=control)
        rfImp<-varImp(fit_rf, scale = FALSE)
        rfImp_scaled<-varImp(fit_rf, scale = TRUE)
        plot(rfImp_scaled, top = 10)
```
The two top have switched places and using one fo the D-words ranks higher, but the general pattern remains the same: Duration in minutes and the proportion of words which were either "I" or "my".


There are a bunch of other fun ways to look at the results of random forests I'd like to explore.
```{r, warning=FALSE, message=FALSE}
library("randomForest")
library("randomForestExplainer")
    set.seed(20181207)
    rf2<- randomForest(disclose ~., data=select(sum_measures, -uid, -cluster, -wrd_cnt_phys, -wrd_cnt_prox), localImp=TRUE)
    min_depth_frame<-min_depth_distribution(rf2)
    plot_min_depth_distribution(min_depth_frame, mean_sample = "all_trees", k=10) 
```

Very cool, so, again, the "I/my" pronouns remain strong.  Sentiment pattern ranked a little more highly.  

Lets look at a couple more measures for these variables. 
```{r, warning=FALSE, message=FALSE}
        importance_frame <- measure_importance(rf2)
        plot2<-plot_multi_way_importance(importance_frame, x_measure = "mean_min_depth", y_measure="p_value", no_of_labels = 5)
        plot2+
            geom_hline(aes(yintercept=0.05))
```
This is a nice example of why any given p-value cut-off is far from the whole story. 

Lets take a quick peek at interactions
```{r, warning=FALSE, message=FALSE}
    plot_predict_interaction(rf2, data=select(sum_measures, -uid, -cluster, -wrd_cnt_phys, -wrd_cnt_prox), "mins", "i_my_prop")
```

So, if the MD's in the room for more than 15 minutes and more than 1% of their words are either "I" or "my", that's a really good sign. 


```{r, warning=FALSE, message=FALSE}
    plot_predict_interaction(rf2, data=select(sum_measures, -uid, -cluster, -wrd_cnt_phys, -wrd_cnt_prox), "pattern_sent", "i_my_prop")
```

##### Last question - are there correlations between physician characterists and the probability they'd be classified as disclosing prognosis?
```{r, warning=FALSE, message=FALSE}
    rf_probs<-predict(fit_rf, type="prob")
    rf_probs$uid<-1:116 
    dta<-dta %>%
        merge(rf_probs, by="uid") %>%
        rename(rf_ProbYes = "Yes", rf_ProbNo = "No") 
    dta<-dta %>%
        mutate(death_word = ifelse(death_word=="Yes", "Yes", "No"))
    
dta_long_con<-dta %>%
    select(uid, age, icu_weeks, disagreement_perceived, effort_to_help, effort_to_listen, effort_to_include, rf_ProbYes, death) %>%
    gather(key=feature, value = value, -uid, -rf_ProbYes, -death) 

dta_long_con %>%
    ggplot(aes(rf_ProbYes, value, colour = death)) +
    geom_point(alpha=0.25)+
    facet_wrap( ~feature, scales='free', ncol=3) +
    labs(x = NULL, y = NULL) +
    theme_bw()

dta_long_cat<-dta %>%
     mutate(Race = fct_collapse(race, 
                                   white = "White", 
                                   asian = "Asian", 
                                   other = c("Black or African American", "More than one race", "Prefer not to answer"))) %>%
     mutate(Religion_importance = fct_collapse(religion_importance, 
                                   high = c("Extremely", "Very"), 
                                   moderate = "Moderately", 
                                   low = c("Slightly", "Not at all"), 
                                   Missing = "Prefer not to answer")) %>%
     select(-c(age, age, icu_weeks, disagreement_perceived, effort_to_help, effort_to_listen, effort_to_include, comfort, comfort_understandable, 
              assesser, rf_ProbNo, withdraw, state, prognosis_mc, religion_importance, race)) %>%
    gather(key=feature, value = value, -uid, -rf_ProbYes, -death) 

dta_long_cat %>%
    ggplot(aes(value, rf_ProbYes)) +
    geom_boxplot(alpha=0.25) +
    facet_wrap( ~feature, scales='free', ncol=5) +
    labs(x = NULL, y = NULL) +
    theme_bw()    
```
Ok, still need to fix "Death_word" variable, re-order the religion importance, drop prognosis survive, and disagreement. 


*Narrative and Summary: What did you learn about the data? How did you answer the questions? How can you justify your answers? What are the limitations of the analyses?
